app-id: org.gnome.gThumb
runtime: org.gnome.Platform
runtime-version: '44'
sdk: org.gnome.Sdk

command: gthumb

finish-args:
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
  - --device=dri
  - --share=ipc
  - --talk-name=org.freedesktop.secrets
  - --filesystem=xdg-config/gtk-3.0
  - --filesystem=xdg-public-share
  - --filesystem=xdg-pictures
  - --filesystem=xdg-run/gvfs
  - --filesystem=xdg-run/gvfsd
  - --talk-name=org.gtk.vfs.*

cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /lib/girepository-*
  - "*.a"
  - "*.la"

modules:
  - name: exiv2
    buildsystem: cmake-ninja
    cleanup:
      - /lib/exiv2
      - /share/man
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DEXIV2_BUILD_EXIV2_COMMAND=OFF
      - -DEXIV2_BUILD_SAMPLES=OFF
    sources:
      - type: archive
        url: https://github.com/Exiv2/exiv2/releases/download/v0.27.5/exiv2-0.27.5-Source.tar.gz
        sha256: 35a58618ab236a901ca4928b0ad8b31007ebdc0386d904409d825024e45ea6e2

  # intltool needed by colord 1.3.5
  - shared-modules/intltool/intltool-0.51.json
  # colord 1.3.5 can be built without gusb and its dependencies, while 1.4.x require gusb.
  - name: colord
    config-opts:
      - --disable-gusb
      - --disable-udev
      - --disable-polkit
      - --disable-systemd-login
      - --disable-argyllcms-sensor
      - --disable-bash-completion
      - --with-tmpfilesdir=/app/lib
      - --with-systemdsystemunitdir=/app/lib
      - --with-udevrulesdir=/app/lib
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/colord/releases/colord-1.3.5.tar.xz
        sha256: 2daa8ffd2a532d7094927cd1a4af595b8310cea66f7707edcf6ab743460feed2

  # adapted from https://github.com/flathub/org.free_astro.siril/blob/master/org.free_astro.siril.json#L257-L282
  - name: libheif
    config-opts:
      - "--disable-gdk-pixbuf"
    cleanup:
      - "/bin"
      - "/share/man"
    modules:
      - name: libde265
        config-opts:
          - "--disable-sherlock265"
        cleanup:
          - "/bin"
        sources:
          - type: archive
            url: https://github.com/strukturag/libde265/releases/download/v1.0.8/libde265-1.0.8.tar.gz
            sha256: 24c791dd334fa521762320ff54f0febfd3c09fc978880a8c5fbc40a88f21d905
    sources:
      - url: https://github.com/strukturag/libheif/releases/download/v1.12.0/libheif-1.12.0.tar.gz
        sha256: e1ac2abb354fdc8ccdca71363ebad7503ad731c84022cf460837f0839e171718
        type: archive

  - name: libjxl
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_TESTING=OFF
    cleanup:
      - /bin
    modules:
      - name: highway
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_TESTING=OFF
        sources:
          - type: archive
            url: https://github.com/google/highway/archive/refs/tags/0.15.0.tar.gz
            sha256: 4bbd4439eae08cf038f1c5cc5d9ebc6a1a50f2c610c13a1483adccacfa24c150
    # Using git because it downloads automatically some build dependencies as submodules.
    sources:
      - type: git
        url: https://github.com/libjxl/libjxl.git
        tag: v0.6.1

  - name: libraw
    config-opts:
      - --disable-examples
    sources:
      - type: archive
        url: https://www.libraw.org/data/LibRaw-0.20.2.tar.gz
        sha256: dc1b486c2003435733043e4e05273477326e51c3ea554c6864a4eafaff1004a6
      - type: shell
        commands:
          - autoreconf -fi
    cleanup:
      - /share/doc

  - name: totem-pl-parser
    buildsystem: meson
    config-opts:
      - -Dbuildtype=release
    sources:
      - type: archive
        url: https://download.gnome.org/sources/totem-pl-parser/3.26/totem-pl-parser-3.26.6.tar.xz
        sha256: c0df0f68d5cf9d7da43c81c7f13f11158358368f98c22d47722f3bd04bd3ac1c

  - name: totem-video-thumbnailer
    buildsystem: meson
    config-opts:
      - -Dbuildtype=release
    sources:
      - type: git
        url: https://gitlab.gnome.org/GNOME/totem-video-thumbnailer.git
        commit: 78ddf6c113d439d8ad9ff1453cf433592fabe9fd

  - name: gThumb
    buildsystem: meson
    config-opts:
      - -Dbuildtype=release
    post-install:
      - install -Dm644 ../data/appdata/org.gnome.gThumb.appdata.xml.in $FLATPAK_DEST/share/appdata/$FLATPAK_ID.appdata.xml
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gthumb/3.12/gthumb-3.12.2.tar.xz
        sha256: 97f8afe522535216541ebbf1e3b546d12a6beb38a8f0eb85f26e676934aad425
      - type: patch
        paths:
          - gthumb-build.patch
          # gThumb expect appstreamcli
          # https://gitlab.gnome.org/GNOME/gthumb/-/issues/224
          - gthumb-appdata.patch
    cleanup:
      - /share/aclocal

